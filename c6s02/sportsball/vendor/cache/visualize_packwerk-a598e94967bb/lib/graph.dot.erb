digraph package_diagram {
  rankdir=TD

  graph [
    labelloc="t"
    fontname="Helvetica,Arial,sans-serif"
    dpi=100
    layout=dot
    label="Visualization of <%= all_packages.count %> packs, generated using `bin/packs`",
    fontsize=24
  ]
  node [
    fontname="Helvetica,Arial,sans-serif"
    fontsize=26.0
    fontcolor=black
    fillcolor=white
    color=black
    height=1.0
    style=filled
    shape=plain
  ]

  <% architecture_layers.each_with_index do |layer_name, index| %>
    subgraph <%= layer_name %> {
      shape=box
      color=darkgrey
      fillcolor=lightblue
      style=filled

      <% if layer_name != "NotInLayer" && options.layers %>
        label="<%= layer_name %>"
        cluster=true
        rank = <%= index %>
      <% end %>

      <% grouped_packages[layer_name].each do |package| %>
        "<%= package.name %>" [
            fontsize=<%= !options.only_package || package.name == options.only_package ? 40.0 : 26.0 %>
            <% if options.only_package %>
              URL="https://github.com/shageman/package-based-rails-applications-book/tree/main/c4s07/sportsball/<%= package.name == '.' ? '' : package.name %>"
            <% end %>
            label= <% if package.enforce_privacy && options.privacy %>
              <
                <table border='0' cellborder='1' cellspacing='0' cellpadding='16'><tr><td>
                  <table border='0' cellborder='1' cellspacing='0' cellpadding='4'>
                    <tr> <td port='private'> <%= package.name %> </td> </tr>
                  </table>
                </td></tr></table>
              >
            <% else %>
              <
                <table border='0' cellborder='1' cellspacing='0' cellpadding='4'>
                  <tr> <td align='left'> <%= package.name %> </td> </tr>
                </table>
              >
            <% end %>
          ]

        <% if options.layers %>
          <% if index > 0 %>
            <% grouped_packages[config.raw['architecture_layers'][index - 1]].each do |upper_layer_node| %>
              <% if all_package_names.include?(upper_layer_node.name) && all_package_names.include?(package.name) %>
                "<%= upper_layer_node.name %>" -> "<%= package.name %>" [
                  style=invis
                ]
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    }
  <% end %>

  <% if options.dependencies %>
    <% all_packages.each do |package| %>
      <% package.dependencies.each do |to_package| %>
        <% if !options.only_package || [package.name, to_package].include?(options.only_package) %>
          "<%= package.name %>" -> "<%= to_package %>" [
            color=darkgreen
          ]
        <% end %>
      <% end %>
    <% end %>
  <% end %>

  <% if options.todos %>
    <% all_packages.each do |package| %>
      <% violations_by_package = package.violations.group_by(&:to_package_name) %>
      <% violations_by_package.keys.each do |violations_to_package| %>
        <% violation_types = violations_by_package[violations_to_package].group_by(&:type) %>
        <% violation_types.keys.each do |violation_type| %>
          <% if !options.only_package || [package.name, violations_to_package].include?(options.only_package) %>
            "<%= package.name %>" -> "<%= violations_to_package %>"<%= violation_type == 'privacy' ? ':private' : '' %> [
              color=darkred
              style=dashed
              constraint=false
              # headlabel="<%= violation_type %>"
              <% if violation_type == 'privacy' %>
                arrowhead=crow
                headport=sw
              <% elsif violation_type == 'architecture' %>
                arrowhead=invodot
                headport=se
              <% elsif violation_type == 'visibility' %>
                arrowhead=obox
                headport=w
              <% elsif violation_type == 'dependency' %>
                arrowhead=odot
                headport=e
              <% end %>
              <%
                max_edge_width = 10

                edge_width = [
                  [(violation_types[violation_type].count / 5).to_i, 1].max, # rubocop:disable Lint/NumberConversion
                  max_edge_width,
                ].min
              %>
              penwidth=<%= edge_width %>
            ]
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>

  subgraph cluster_legend {
    label="Legend"

    A [ fontsize=12 shape=box label="package"]
    B [ fontsize=12 shape=box label="package"]
    C [ fontsize=12 shape=box label="package"]
    D [ fontsize=12 shape=box label="package"]
    E [ fontsize=12 shape=box label="package"]
    F [ fontsize=12 shape=box label="package"]
    G [ fontsize=12 shape=box label="package"]
    H [ fontsize=12 shape=box label="package"]
    I [ fontsize=12 shape=box label="package"]
    J [ fontsize=12 shape=box label="package"]

    A -> B [label="accepted dependency" color=darkgreen]
    C -> D [label="privac todo" color=darkred style=dashed arrowhead=crow]
    E -> F [label="architecture todo" color=darkred style=dashed arrowhead=invodot]
    G -> H [label="visibility todo" color=darkred style=dashed arrowhead=obox]
    I -> J [label="dependency todo" color=darkred style=dashed arrowhead=odot]
  }
}